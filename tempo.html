<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tempo ‚Äì EB de Manhente</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Montserrat',sans-serif;
  background:#f1f5f9;
  color:#1f2933;
}

header{
  background:linear-gradient(135deg,#2563eb,#1e40af);
  color:white;
  padding:25px 20px;
}

.header-content{
  max-width:900px;
  margin:auto;
  display:flex;
  align-items:center;
  gap:20px;
}

.header-content img{
  width:80px;
  background:white;
  border-radius:50%;
  padding:6px;
}

main{
  max-width:900px;
  margin:40px auto;
  padding:0 20px;
}

#cartao-clima{
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  color:white;
  border-radius:20px;
  padding:30px;
  text-align:center;
  box-shadow:0 12px 30px rgba(0,0,0,.2);
}

/* TEMP + √çCONE */
#linha-temp{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
}

#icone-atual{
  font-size:2.2em;
  line-height:1;
}

#temp{
  font-size:3.2em;
  font-weight:700;
}

#dados,#hora,#fonte{
  margin-top:8px;
}

#acessos{
  margin-top:30px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}

.card{
  padding:18px;
  border-radius:14px;
  color:white;
  text-decoration:none;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  transition:.2s;
}

.card:hover{transform:translateY(-4px);}

.wu{background:linear-gradient(135deg,#f59e0b,#d97706);}
.wc{background:linear-gradient(135deg,#38bdf8,#0284c7);}
.pwl{background:linear-gradient(135deg,#22c55e,#15803d);}

#previsao{
  margin-top:50px;
}

#indicadores{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:15px;
  margin-bottom:25px;
}

.indicador,.dia,.sensor{
  background:white;
  padding:15px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}

#dias{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:15px;
}

.icone{
  font-size:2em;
  margin-bottom:6px;
}

#sensores{
  margin-top:50px;
}

#sensores-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:15px;
}

#legenda{
  margin-top:40px;
  padding:25px;
  background:white;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.logo-bora{
  max-width:120px;
  height:auto;
  margin:10px 0;
  transition:transform .2s, opacity .2s;
}

@media (max-width:600px){
  .logo-bora{
    max-width:90px;
  }
}


.logo-bora:hover{
  transform:scale(1.05);
  opacity:.9;
}

footer{
  margin:40px 0 20px;
  text-align:center;
  font-size:.8em;
  color:#6b7280;
}


/* SEM√ÅFORO SISMOS */
.semaforo{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  border-radius:50%;
  margin-right:6px;
  font-size:.7em;
  color:white;
  font-weight:700;
}
.verde{background:#16a34a;}
.amarelo{background:#f59e0b;}
.vermelho{background:#dc2626;}


details summary {
  cursor: pointer;
  font-size: 1.1em;
  margin-top: 25px;
}
details summary::marker {
  font-size: 1.2em;
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="config.js"></script>
</head>

<body>




<header>
  <div class="header-content">
    <img src="logo_meteomanhente.png" alt="MeteoManhente ‚Äì EB de Manhente" style="width:72px;height:72px;object-fit:cover;border-radius:50%;" >
    <div>
      <h1>Tempo Meteorol√≥gico</h1>
      <p>
        <a href="index.html" style="color:white; text-decoration:underline;">
          EB de Manhente
        </a>
        ¬∑ Barcelos
      </p>
    </div>
  </div>
</header>

<main>

<div id="cartao-clima">
  <div id="linha-temp">
    <div id="icone-atual">‚õÖ</div>
    <div id="temp">A carregar‚Ä¶</div>
  </div>
  <div id="dados"></div>
  <div id="hora"></div>
  <div id="fonte"></div>
</div>

<!-- =======================
     GR√ÅFICOS (TEMPERATURA)
     ======================= -->
<div id="charts-temperatura" style="margin-top:40px;">
  <h2>Temperatura ‚Äî gr√°ficos</h2>

  <!-- Bot√µes de per√≠odo -->
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px;">
    <button class="btn-periodo" data-days="7"  style="border:1px solid #cbd5e1; background:#ffffff; padding:8px 12px; border-radius:10px; cursor:pointer;">7 dias</button>
    <button class="btn-periodo" data-days="14" style="border:1px solid #cbd5e1; background:#ffffff; padding:8px 12px; border-radius:10px; cursor:pointer;">14 dias</button>
    <button class="btn-periodo" data-days="30" style="border:1px solid #cbd5e1; background:#ffffff; padding:8px 12px; border-radius:10px; cursor:pointer;">30 dias</button>
  </div>

  <!-- Gr√°fico di√°rio -->
  <div class="indicador" style="text-align:left;">
    <strong>Di√°rio (m√≠n / m√©dia / m√°x)</strong>
    <div style="position:relative; height:260px; margin-top:12px;">
      <canvas id="tempDailyChart"></canvas>
    </div>
    <div id="tempDailyInsight" style="margin-top:10px; font-size:.9em; color:#334155;">A carregar‚Ä¶</div>
    <div id="tempDailyNote" style="margin-top:6px; font-size:.85em; color:#64748b;">Fonte: Esta√ß√£o meteorol√≥gica (Weather Underground).</div>
  </div>

  <!-- Gr√°fico hor√°rio -->
  <div class="indicador" style="text-align:left; margin-top:15px;">
    <strong>Hoje (hora a hora)</strong>
    <div style="position:relative; height:240px; margin-top:12px;">
      <canvas id="tempHourlyChart"></canvas>
    </div>
    <div id="tempHourlyNote" style="margin-top:8px; font-size:.85em; color:#64748b;">A carregar‚Ä¶</div>
  </div>
</div>

<div id="acessos">
  <a class="card wu" href="https://www.wunderground.com/weather/pt/manhente/IMANHE1" target="_blank">
    Weather Underground<br><small>Acesso livre</small>
  </a>
  <a class="card wc" href="https://app.weathercloud.net/d7620547198#current" target="_blank">
    WeatherCloud<br><small>Acesso livre</small>
  </a>
  <a class="card pwl" href="https://proweatherlive.net/dashboard?id=69397140b67eb10008cb6d87" target="_blank">
    ProWeatherLive<br><small>Acesso reservado</small>
  </a>
</div>

<div id="previsao">
  <h2>Previs√£o Meteorol√≥gica ‚Äì Manhente</h2>

  <div id="indicadores">
    <div class="indicador"><strong>Press√£o</strong><br><span id="pressao">‚Äî</span></div>
    <div class="indicador"><strong>√çndice UV</strong><br><span id="uv">‚Äî</span></div>
    <div class="indicador"><strong>Rajadas</strong><br><span id="rajadas">‚Äî</span></div>
  </div>

  <div id="dias"></div>

<div id="qualidade-ar" style="margin-top:50px;">
  <h2>Qualidade do Ar</h2>

  <div id="aq-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:15px;">
    <div class="indicador"><strong>PM2.5</strong><br><span id="pm25">‚Äî</span></div>
    <div class="indicador"><strong>√çndice (EU)</strong><br><span id="aqi-eu">‚Äî</span></div>
    <div class="indicador"><strong>Estado</strong><br><span id="aq-estado">‚Äî</span></div>
  </div>

  <div style="margin-top:10px; font-size:.85em; color:#475569;">
    Atualizado: <span id="aq-hora">‚Äî</span> ¬∑ Fonte: Open‚ÄëMeteo (modelo)
  </div>
</div>

</div>

<details open>
  <summary><strong>Sensores da esta√ß√£o local</strong></summary>
  <div id="sensores">
    <h2>Sensores da Esta√ß√£o Local</h2>
    <div id="sensores-grid"></div>
  </div>
</details>


<div id="rosa-dos-ventos" style="margin-top:40px;">
  <h2>Rosa dos Ventos (hoje)</h2>

  <div class="info-grid" style="margin:12px 0 14px;">
    <div class="info-card">
      <h3>M√©dia di√°ria do vento</h3>
      <p id="vento-dia-media">‚Äî</p>
    </div>
    <div class="info-card">
      <h3>Rajada m√°x. do dia</h3>
      <p id="vento-dia-rajada-max">‚Äî</p>
    </div>
  </div>

  <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
    <div style="width:260px; max-width:90vw;">
      <svg id="windrose" viewBox="0 0 200 200" style="width:100%; height:auto; background:#ffffff; border:1px solid #e2e8f0; border-radius:12px;"></svg>
      <div style="margin-top:8px; font-size:.85em; color:#475569;">Baseado nas observa√ß√µes da esta√ß√£o (dire√ß√£o m√©dia por per√≠odo nas √∫ltimas 24h).</div>
    </div>

    <div style="min-width:240px; flex:1;">
      <div style="font-size:.9em; color:#0f172a;"><strong>Distribui√ß√£o por dire√ß√£o (m√©dia por per√≠odo)</strong></div>
      <div id="windrose-legend" style="margin-top:10px; display:grid; grid-template-columns:repeat(2, minmax(120px,1fr)); gap:8px;"></div>
    </div>
  </div>
</div>








<div id="sismos" style="margin-top:50px;">
  <h2>Sismos</h2>

  <div id="sismos-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:15px;">
    <details open>
<summary><strong>Portugal ‚Äì mais recentes</strong></summary>
<div class="indicador">
      <strong>Portugal ‚Äì mais recentes</strong>
      <div id="sismos-pt-recentes" style="margin-top:10px; text-align:left;">A carregar‚Ä¶</div>
      <div style="margin-top:10px;">
        <a href="https://www.ipma.pt/pt/geofisica/sismicidade/" target="_blank" rel="noopener noreferrer">Ver sismicidade (IPMA)</a>
      </div>
    </div>
</details>

    <details open>
<summary><strong>Portugal ‚Äì Norte priorit√°rio</strong></summary>
<div class="indicador">
      <strong>Portugal ‚Äì Norte priorit√°rio</strong>
      <div id="sismos-pt-norte" style="margin-top:10px; text-align:left;">A carregar‚Ä¶</div>
      <div style="margin-top:10px;">
        <a href="https://www.ipma.pt/pt/geofisica/sismicidade/" target="_blank" rel="noopener noreferrer">Ver sismicidade (IPMA)</a>
      </div>
    </div>
</details>

    <details open>
<summary><strong>Mais relevantes no mundo</strong></summary>
<div class="indicador">
      <strong>Mais relevantes no mundo</strong>
      <div id="sismos-mundo" style="margin-top:10px; text-align:left;">A carregar‚Ä¶</div>
      <div style="margin-top:10px;">
        <a href="https://earthquake.usgs.gov/earthquakes/map/?extent=-90,-180&extent=90,180" target="_blank" rel="noopener noreferrer">Ver mapa (USGS)</a>
      </div>
    </div>
</details>
  </div>

  <div style="margin-top:10px; font-size:.85em; color:#475569;">
    üü¢ Fraco &nbsp; üü° Moderado &nbsp; üî¥ Forte ‚Äî classifica√ß√£o baseada na magnitude.
  </div>
</div>

<div id="legenda">


Com o apoio da Associa√ß√£o<br>
  <a href="https://borambientar.pt/" target="_blank" rel="noopener noreferrer">
    <img src="logo-bora-ambientar.png" alt="BORA AMBIENTAR" class="logo-bora">
  </a>
  <br>
  	<strong>EB de Manhente</strong>
</div>

</main>

<footer>
  P√°gina informativa com dados meteorol√≥gicos
</footer>

<script>
const __cfg = (window.WU_CONFIG || {});
const stationId = __cfg.stationId || "IMANHE1";
const apiKey = __cfg.apiKey || "cc9cbc0aeacb47899cbc0aeacbc7891b";
// 1 casa decimal
function format1(n){
  const x = Number(n);
  if (Number.isNaN(x)) return "‚Äî";
  return x.toFixed(1);
}

// √çCONES (Open-Meteo weathercode)
function iconeTempo(code){
  if(code===0)return"‚òÄÔ∏è";
  if([1,2].includes(code))return"üå§Ô∏è";
  if(code===3)return"‚òÅÔ∏è";
  if([45,48].includes(code))return"üå´Ô∏è";
  if([51,53,55,61,63,65].includes(code))return"üåßÔ∏è";
  if([66,67].includes(code))return"üåßÔ∏è‚ùÑÔ∏è";
  if([71,73,75,77].includes(code))return"‚ùÑÔ∏è";
  if([80,81,82].includes(code))return"üå¶Ô∏è";
  if([95,96,99].includes(code))return"‚õàÔ∏è";
  return"üå°Ô∏è";
}

// SENSOR CARD
function sensor(nome, valor, unidade=""){
  if(valor===undefined || valor===null) return "";
  return `<div class="sensor"><strong>${nome}</strong><br>${valor}${unidade}</div>`;
}

// UI ATUAL
function atualizarAtual(temp, hum, vento, fonte, icone){
  document.getElementById("temp").innerText = format1(temp) + "¬∞C";
  document.getElementById("icone-atual").innerText = icone || "üå°Ô∏è";
  document.getElementById("dados").innerText =
    `Humidade: ${hum} ¬∑ Vento: ${format1(vento)} km/h`;
  document.getElementById("hora").innerText =
    "Atualizado: "+new Date().toLocaleTimeString("pt-PT",{hour:"2-digit",minute:"2-digit"});
  document.getElementById("fonte").innerText = "Fonte: " + fonte;
}

// Buscar √≠cone (estado do tempo) no Open-Meteo (s√≥ para o √≠cone)
let iconeAtual = "üå°Ô∏è";
const iconePromise = fetch("https://api.open-meteo.com/v1/forecast?latitude=41.5388&longitude=-8.6151&current_weather=true&timezone=Europe/Lisbon")
  .then(r=>r.json())
  .then(d=>{ iconeAtual = iconeTempo(d.current_weather.weathercode); })
  .catch(()=>{ iconeAtual = "üå°Ô∏è"; });

// WEATHER UNDERGROUND (esta√ß√£o local)
Promise.all([iconePromise]).then(()=>{
  return fetch(`https://api.weather.com/v2/pws/observations/current?stationId=${encodeURIComponent(stationId)}&format=json&units=m&apiKey=${apiKey}`);
})
.then(r=>r.json())
.then(d=>{
  if(!d.observations) throw "offline";
  const o=d.observations[0];

  atualizarAtual(
    o.metric.temp,
    o.humidity+"%",
    o.metric.windSpeed,
    "Esta√ß√£o local",
    iconeAtual
  );

  document.getElementById("sensores-grid").innerHTML =
    sensor("Press√£o", o.metric.pressure, " hPa") +
    sensor("Sensa√ß√£o T√©rmica", format1(o.metric.heatIndex), " ¬∞C") +
    sensor("Ponto de Orvalho", format1(o.metric.dewpt), " ¬∞C") +
    sensor("Wind Chill", format1(o.metric.windChill), " ¬∞C") +
    sensor("Vento (atual)", o.metric.windSpeed, " km/h") +
    sensor("Rajada (m√°x. recente)", o.metric.windGust, " km/h") +
    sensor("Dire√ß√£o do vento", o.winddir, "¬∞") +
    sensor("√çndice UV", o.uv) +
    sensor("Radia√ß√£o Solar", o.solarRadiation, " W/m¬≤") +
    sensor("Visibilidade", o.metric.visibility, " km") +
    sensor("Chuva (hora)", o.metric.precipRate, " mm/h") +
    sensor("Chuva (dia)", o.metric.precipToday, " mm") +
    sensor("Chuva acumulada", o.metric.precipTotal, " mm");
})
.catch(()=>{
  // FALLBACK (Open-Meteo total)
  fetch("https://api.open-meteo.com/v1/forecast?latitude=41.5388&longitude=-8.6151&current_weather=true&timezone=Europe/Lisbon")
  .then(r=>r.json())
  .then(d=>{
    atualizarAtual(
      d.current_weather.temperature,
      "‚Äî",
      d.current_weather.windspeed,
      "Modelo meteorol√≥gico",
      iconeTempo(d.current_weather.weathercode)
    );
    // sensores ficam vazios no fallback
    document.getElementById("sensores-grid").innerHTML =
      `<div class="sensor"><strong>Sensores</strong><br>Indispon√≠veis (esta√ß√£o offline)</div>`;
  });
});

// PREVIS√ÉO
fetch("https://api.open-meteo.com/v1/forecast?latitude=41.5388&longitude=-8.6151&daily=temperature_2m_max,temperature_2m_min,uv_index_max,precipitation_probability_max,weathercode&current=surface_pressure,wind_gusts_10m&timezone=Europe/Lisbon")
.then(r=>r.json())
.then(d=>{
  document.getElementById("pressao").innerText=d.current.surface_pressure+" hPa";
  document.getElementById("uv").innerText=d.daily.uv_index_max[0];
  document.getElementById("rajadas").innerText=format1(d.current.wind_gusts_10m)+" km/h";

  const dias=document.getElementById("dias");
  dias.innerHTML="";
  d.daily.time.slice(0,5).forEach((dia,i)=>{
    dias.innerHTML+=`
      <div class="dia">
        <div class="icone">${iconeTempo(d.daily.weathercode[i])}</div>
        <strong>${new Date(dia).toLocaleDateString("pt-PT",{weekday:"short"})}</strong><br>
        M√°x: ${format1(d.daily.temperature_2m_max[i])}¬∞C<br>
        M√≠n: ${format1(d.daily.temperature_2m_min[i])}¬∞C<br>
        Chuva: ${d.daily.precipitation_probability_max[i]}%
      </div>`;
  });
});



// =======================
// QUALIDADE DO AR (Open-Meteo Air Quality)
// =======================
function estadoArPorPM25(pm25){
  if(pm25===null || pm25===undefined || Number.isNaN(pm25)) return "‚Äî";
  // Escala simples (aprox.) baseada em orienta√ß√µes comuns (¬µg/m¬≥)
  if(pm25 <= 5) return "Excelente";
  if(pm25 <= 10) return "Boa";
  if(pm25 <= 15) return "Razo√°vel";
  if(pm25 <= 25) return "Moderada";
  if(pm25 <= 35) return "Fraca";
  if(pm25 <= 50) return "M√°";
  return "Muito m√°";
}

function fmtHoraCurta(dt){
  return dt.toLocaleTimeString("pt-PT",{hour:"2-digit",minute:"2-digit"});
}

function setAQ(elId, value){
  const el = document.getElementById(elId);
  if(!el) return;
  el.innerText = value;
}

fetch("https://air-quality-api.open-meteo.com/v1/air-quality?latitude=41.5388&longitude=-8.6151&current=pm2_5,european_aqi&timezone=Europe/Lisbon")
  .then(r=>r.json())
  .then(d=>{
    const pm25 = d?.current?.pm2_5;
    const aqi = d?.current?.european_aqi;

    setAQ("pm25", (pm25===undefined || pm25===null) ? "‚Äî" : (format1(pm25) + " ¬µg/m¬≥"));
    setAQ("aqi-eu", (aqi===undefined || aqi===null) ? "‚Äî" : aqi);
    setAQ("aq-estado", estadoArPorPM25(pm25));
    setAQ("aq-hora", fmtHoraCurta(new Date()));
  })
  .catch(()=>{
    setAQ("aq-estado", "Indispon√≠vel");
    setAQ("aq-hora", fmtHoraCurta(new Date()));
  });



// =======================
// VENTO DO DIA + ROSA DOS VENTOS
// - M√©dia di√°ria + rajada m√°x.: dailysummary/7day (usa sempre o registo mais recente)
// - Rosa dos ventos: observations/all/1day (fallback: seta pela dire√ß√£o m√©dia do dia)
// =======================
function safeNum(x){
  const n = Number(x);
  return Number.isNaN(n) ? null : n;
}
function setTxt(id, txt){
  const el = document.getElementById(id);
  if (el) el.innerText = txt;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function todayYMD(){
  const d = new Date();
  return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
}
function sector8(deg){
  const dirs = ["N","NE","E","SE","S","SW","W","NW"];
  if(deg===null || deg===undefined) return null;
  let a = ((deg % 360) + 360) % 360;
  const i = Math.floor((a + 22.5) / 45) % 8;
  return {i, label: dirs[i]};
}
function renderWindRose(counts){
  const svg = document.querySelector("#rosa-dos-ventos #windrose");
  if(!svg) return;
  svg.innerHTML = "";
  const cx=100, cy=100;
  const NS="http://www.w3.org/2000/svg";
  [20,40,60,80].forEach(r=>{
    const c=document.createElementNS(NS,"circle");
    c.setAttribute("cx",cx); c.setAttribute("cy",cy); c.setAttribute("r",r);
    c.setAttribute("fill","none"); c.setAttribute("stroke","#e2e8f0");
    svg.appendChild(c);
  });
  [{t:"N",x:100,y:14},{t:"E",x:186,y:104},{t:"S",x:100,y:196},{t:"W",x:14,y:104}].forEach(L=>{
    const tx=document.createElementNS(NS,"text");
    tx.textContent=L.t;
    tx.setAttribute("x",L.x); tx.setAttribute("y",L.y);
    tx.setAttribute("text-anchor","middle");
    tx.setAttribute("font-size","12");
    tx.setAttribute("fill","#334155");
    svg.appendChild(tx);
  });

  const maxCount = Math.max(...counts, 0);
  const maxBar = 80;

  for(let i=0;i<8;i++){
    const count = counts[i] || 0;
    const len = maxCount>0 ? (count/maxCount)*maxBar : 0;
    const angle = (-90 + i*45) * Math.PI/180;
    const x2 = cx + Math.cos(angle)*len;
    const y2 = cy + Math.sin(angle)*len;

    const line=document.createElementNS(NS,"line");
    line.setAttribute("x1",cx); line.setAttribute("y1",cy);
    line.setAttribute("x2",x2); line.setAttribute("y2",y2);
    line.setAttribute("stroke","#0f172a");
    line.setAttribute("stroke-width","6");
    line.setAttribute("stroke-linecap","round");
    svg.appendChild(line);
  }
}
function drawAvgDirectionArrow(deg){
  const svg = document.querySelector("#rosa-dos-ventos #windrose");
  if(!svg) return;
  const NS="http://www.w3.org/2000/svg";
  const cx=100, cy=100;
  const angle = ((deg ?? 0) - 90) * Math.PI/180;
  const x2 = cx + Math.cos(angle)*70;
  const y2 = cy + Math.sin(angle)*70;

  const line=document.createElementNS(NS,"line");
  line.setAttribute("x1",cx); line.setAttribute("y1",cy);
  line.setAttribute("x2",x2); line.setAttribute("y2",y2);
  line.setAttribute("stroke","#0b5ed7");
  line.setAttribute("stroke-width","5");
  line.setAttribute("stroke-linecap","round");
  svg.appendChild(line);

  const tip=document.createElementNS(NS,"circle");
  tip.setAttribute("cx",x2); tip.setAttribute("cy",y2); tip.setAttribute("r","4");
  tip.setAttribute("fill","#0b5ed7");
  svg.appendChild(tip);
}
function renderWindRoseLegend(counts, note){
  const wrap=document.querySelector("#rosa-dos-ventos #windrose-legend");
  if(!wrap) return;
  const dirs=["N","NE","E","SE","S","SW","W","NW"];
  wrap.innerHTML="";
  if(note){
    const p=document.createElement("div");
    p.style.gridColumn="1 / -1";
    p.style.padding="10px";
    p.style.border="1px dashed #cbd5e1";
    p.style.borderRadius="10px";
    p.style.color="#475569";
    p.textContent = note;
    wrap.appendChild(p);
  }
  dirs.forEach((d,i)=>{
    const div=document.createElement("div");
    div.style.padding="8px 10px";
    div.style.border="1px solid #e2e8f0";
    div.style.borderRadius="10px";
    div.style.background="#fff";
    div.innerHTML = `<strong>${d}</strong>: ${counts[i] || 0}`;
    wrap.appendChild(div);
  });
}

(function(){
  const cfg = (window.WU_CONFIG || {});
  if(!cfg.stationId || !cfg.apiKey) return;

  const ymd = todayYMD();
  let summaryToday = null;

  const urlDaily = "https://api.weather.com/v2/pws/dailysummary/7day"
    + "?stationId=" + encodeURIComponent(cfg.stationId)
    + "&format=json&units=m&numericPrecision=decimal"
    + "&apiKey=" + encodeURIComponent(cfg.apiKey);

  fetch(urlDaily)
    .then(r => r.ok ? r.json() : Promise.reject(r.status))
    .then(d => {
      const sums = Array.isArray(d?.summaries) ? d.summaries : [];
      const byEpoch = sums.slice().sort((a,b)=>(a.epoch||0)-(b.epoch||0));
      const latest = byEpoch[byEpoch.length-1] || null;
      const today = sums.find(s => typeof s?.obsTimeLocal === "string" && s.obsTimeLocal.startsWith(ymd)) || latest;

      summaryToday = today || latest;

      const m = summaryToday?.metric || {};
      const mean = safeNum(m.windspeedAvg);
      const gustHigh = safeNum(m.windgustHigh);

      setTxt("vento-dia-media", mean===null ? "‚Äî" : `${mean.toFixed(1)} km/h`);
      setTxt("vento-dia-rajada-max", gustHigh===null ? "‚Äî" : `${gustHigh.toFixed(1)} km/h`);
    })
    .catch(() => {});

  const urlRose = "https://api.weather.com/v2/pws/observations/all/1day"
    + "?stationId=" + encodeURIComponent(cfg.stationId)
    + "&format=json&units=m&numericPrecision=decimal"
    + "&apiKey=" + encodeURIComponent(cfg.apiKey);

  fetch(urlRose)
    .then(r => r.ok ? r.json() : Promise.reject(r.status))
    .then(d => {
      const obs = Array.isArray(d?.observations) ? d.observations : [];
      const rowsToday = obs.filter(o => typeof o?.obsTimeLocal === "string" && o.obsTimeLocal.startsWith(ymd));
      const rows = rowsToday.length ? rowsToday : obs;

      const counts = new Array(8).fill(0);
      rows.forEach(o=>{
        const wd = safeNum((o.winddir ?? o.winddirAvg));
        const s = sector8(wd);
        if(s) counts[s.i] += 1;
      });

      const total = counts.reduce((a,b)=>a+b,0);
      renderWindRose(counts);

      if(total === 0){
        const avg = safeNum(summaryToday?.winddirAvg);
        if(avg!==null){
          drawAvgDirectionArrow(avg);
          const s = sector8(avg);
          renderWindRoseLegend(counts, `Dire√ß√µes calculadas a partir de m√©dias por per√≠odo. Dire√ß√£o m√©dia do dia: ${avg.toFixed(0)}¬∞ (${s ? s.label : "‚Äî"}).`);
        }else{
          renderWindRoseLegend(counts, "Ainda sem dados suficientes para construir a rosa dos ventos (hoje).");
        }
        return;
      }
      renderWindRoseLegend(counts, null);
    })
    .catch((status) => {
      const counts = new Array(8).fill(0);
      renderWindRose(counts);
      const msg = (status === 204)
        ? "Sem hist√≥rico (204) neste momento. A rosa aparece quando existirem registos suficientes."
        : "Hist√≥rico por amostras indispon√≠vel com esta chave de API (necess√°rio para a rosa dos ventos).";
      renderWindRoseLegend(counts, msg);
    });
})();


// =======================
// SISMOS (USGS - dados p√∫blicos)
// =======================

// Feeds USGS GeoJSON (p√∫blicos)
const USGS_ALL_WEEK = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson";
const USGS_SIGNIFICANT_WEEK = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_week.geojson";

// IPMA (sismicidade Portugal) ‚Äì dados p√∫blicos (30 dias)
const IPMA_SEISMIC_CONT = "https://api.ipma.pt/open-data/observation/seismic/7.json";
const IPMA_SEISMIC_AZORES = "https://api.ipma.pt/open-data/observation/seismic/3.json";


// Portugal (bbox abrangente: continente + A√ßores/Madeira com folga)
const PT_BBOX = {
  minLat: 30.0,
  maxLat: 43.5,
  minLon: -32.5,
  maxLon: -6.0
};

function dentroBBox(lat, lon, bbox){
  return lat >= bbox.minLat && lat <= bbox.maxLat && lon >= bbox.minLon && lon <= bbox.maxLon;
}

function fmtData(ms){
  return new Date(ms).toLocaleString("pt-PT", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function fmtNum(n, casas=1){
  if(n === null || n === undefined) return "‚Äî";
  return Number(n).toFixed(casas);
}

function semaforoMag(mag){
  if(mag === null || mag === undefined) return "";
  if(mag < 4) return `<span class="semaforo verde">‚óè</span>`;
  if(mag < 6) return `<span class="semaforo amarelo">‚óè</span>`;
  return `<span class="semaforo vermelho">‚óè</span>`;
}

function criarLinhaSismo(f){
  const p = f.properties || {};
  const g = f.geometry || {};
  const coords = (g.coordinates || []);
  const depth = coords[2];

  const mag = p.mag;
  const place = p.place || "Local desconhecido";
  const time = p.time;
  const felt = p.felt; // n¬∫ de relatos "felt" (quando existe)
  const cdi = p.cdi;   // intensidade (quando existe)
  const url = p.url;   // link oficial do evento

  const badge =
    (felt ? `üë• ${felt}` : "") +
    (cdi ? ` ¬∑ Int. ${fmtNum(cdi,1)}` : "");

  return `
    <div style="padding:10px 0; border-bottom:1px solid #e5e7eb;">
      <div style="font-weight:700;">
        ${semaforoMag(mag)} M ${fmtNum(mag,1)} ¬∑ ${place}
      </div>
      <div style="font-size:.9em; color:#334155;">
        ${fmtData(time)} ¬∑ Prof.: ${fmtNum(depth,0)} km ${badge ? "¬∑ " + badge : ""}
      </div>
      ${url ? `<div style="margin-top:4px;"><a href="${url}" target="_blank" rel="noopener noreferrer">Detalhes</a></div>` : ""}
    </div>
  `;
}


// Prefer√™ncias locais (Portugal)
// Ajusta este valor se quiseres um 'Norte' mais apertado/mais largo.
const NORTE_MIN_LAT = 40.2; // ~Minho/Porto para cima

function isNortePT(ev){
  const lat = parseFloat(ev.lat);
  return !Number.isNaN(lat) && lat >= NORTE_MIN_LAT;
}

function hasDegree(ev){
  return ev.degree !== null && ev.degree !== undefined && ev.degree !== "";
}


async function carregarSismosPortugal(){
  const elRecentes = document.getElementById("sismos-pt-recentes");
  const elNorte = document.getElementById("sismos-pt-norte");
  if(!elRecentes || !elNorte) return;

  try{
    const [r1, r2] = await Promise.all([
      fetch(IPMA_SEISMIC_CONT),
      fetch(IPMA_SEISMIC_AZORES)
    ]);

    const [cont, azo] = await Promise.all([r1.json(), r2.json()]);

    const items = []
      .concat((cont.data || []).map(x => ({...x, __area: "Continente/Madeira"})))
      .concat((azo.data || []).map(x => ({...x, __area: "A√ßores"})));

    const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

    const normalizados = items.map(it => {
      const t = new Date(it.time + "Z").getTime();
      return {...it, __t: t};
    }).filter(it => !Number.isNaN(it.__t) && it.__t >= weekAgo);

    // OP√á√ÉO 1 ‚Äì mais recentes
    const recentes = [...normalizados]
      .sort((a,b) => b.__t - a.__t)
      .slice(0, 8);

    // OP√á√ÉO 2 ‚Äì Norte priorit√°rio
    const NORTE_MIN_LAT = 40.2;
    const norte = [...normalizados]
      .sort((a,b) => {
        const aN = (Number(a.lat) >= NORTE_MIN_LAT) ? 1 : 0;
        const bN = (Number(b.lat) >= NORTE_MIN_LAT) ? 1 : 0;
        if(bN !== aN) return bN - aN;
        return b.__t - a.__t;
      })
      .slice(0, 8);

    elRecentes.innerHTML = recentes.length
      ? recentes.map(renderIPMA).join("")
      : "<div>Sem registos na √∫ltima semana.</div>";

    elNorte.innerHTML = norte.length
      ? norte.map(renderIPMA).join("")
      : "<div>Sem registos no Norte na √∫ltima semana.</div>";

  }catch(e){
    elRecentes.innerHTML = "Erro ao carregar dados (IPMA)";
    elNorte.innerHTML = "Erro ao carregar dados (IPMA)";
  }
}


function renderIPMA(it){
  const mag = Number(it.magnitud);
  const badge = (it.degree !== null && it.degree !== undefined && String(it.degree).trim() !== "")
    ? ` ¬∑ Intensidade ${it.degree}` : "";

  // Campo do local no IPMA pode variar; tentamos v√°rios para n√£o ficar vazio.
  const placeCore =
    (it.local && String(it.local).trim()) ||
    (it.obsRegion && String(it.obsRegion).trim()) ||
    (it.region && String(it.region).trim()) ||
    (it.place && String(it.place).trim()) ||
    "Portugal";

  const place = `${placeCore} (${it.__area || ""})`.replace(/\s+\(\)/g,"").trim();

  return `
    <div style="padding:10px 0; border-bottom:1px solid #e5e7eb;">
      <div style="font-weight:700;">
        ${semaforoMag(mag)} M ${fmtNum(mag,1)} ¬∑ ${place}
      </div>
      <div style="font-size:.9em; color:#334155;">
        ${fmtData(it.__t)} ¬∑ Prof.: ${fmtNum(it.depth,0)} km${badge}
      </div>
    </div>
  `;
}

async function carregarSismosMundoRelevantes(){
  const el = document.getElementById("sismos-mundo");
  if(!el) return;

  try{
    const r = await fetch(USGS_SIGNIFICANT_WEEK);
    const data = await r.json();
    const feats = (data.features || [])
      .sort((a,b) => (b.properties.mag || 0) - (a.properties.mag || 0))
      .slice(0, 5);

    if(feats.length === 0){
      el.innerHTML = `<div style="color:#334155;">Sem sismos "significativos" registados (√∫ltima semana).</div>`;
      return;
    }

    el.innerHTML = feats.map(criarLinhaSismo).join("");
  }catch(e){
    el.innerHTML = `<div style="color:#b91c1c;">N√£o foi poss√≠vel carregar os dados (USGS).</div>`;
  }
}

// Carregar ao abrir a p√°gina
carregarSismosPortugal();
carregarSismosMundoRelevantes();



// =======================
// GR√ÅFICOS DE TEMPERATURA (ESTA√á√ÉO LOCAL)
// - Di√°rio: dailysummary/30day (slice 7/14/30)
// - Hor√°rio (hoje): observations/all/1day
// =======================
let __tempDailyChart = null;
let __tempHourlyChart = null;
// cache para evitar m√∫ltiplos fetch e para sabermos quantos dias o endpoint devolve
let __dailySummariesCache = null;
let __dailySummariesMeta = { endpoint: null, count: 0 };

function __setActivePeriodo(days){
  document.querySelectorAll('.btn-periodo').forEach(b=>{
    const isOn = String(b.dataset.days) === String(days);
    b.style.background = isOn ? '#e0f2fe' : '#ffffff';
    b.style.borderColor = isOn ? '#38bdf8' : '#cbd5e1';
    b.style.fontWeight = isOn ? '700' : '600';
  });
}

function __safeNum(x){
  const n = Number(x);
  return Number.isNaN(n) ? null : n;
}

function __format1(n){
  const x = Number(n);
  if (Number.isNaN(x)) return '‚Äî';
  return x.toFixed(1);
}

function __sameDayLocal(a, b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function __buildDailyInsight(days, daily){
  const el = document.getElementById('tempDailyInsight');
  if(!el) return;

  if(!daily || daily.labels.length < 2){
    el.textContent = 'Sem dados suficientes para an√°lise.';
    return;
  }

  const iLast = daily.labels.length - 1;
  const tMin = daily.min[iLast];
  const tMax = daily.max[iLast];
  const amp = (tMin!=null && tMax!=null) ? (tMax - tMin) : null;

  // m√©dia da amplitude nos dias anteriores
  const amps = [];
  for(let i=0;i<iLast;i++){
    if(daily.min[i]!=null && daily.max[i]!=null) amps.push(daily.max[i]-daily.min[i]);
  }
  const avgAmp = amps.length ? (amps.reduce((a,b)=>a+b,0)/amps.length) : null;

  let comp = '';
  if(amp!=null && avgAmp!=null){
    const diff = amp - avgAmp;
    const abs = Math.abs(diff);
    const dir = diff >= 0 ? 'superior' : 'inferior';
    comp = `, ${abs.toFixed(1)}¬∞C ${dir} √† m√©dia dos √∫ltimos ${days} dias`;
  }

  // frase final
  el.innerHTML = `Hoje: <strong>${__format1(tMin)}¬∞C</strong> (m√≠n) ‚Äî <strong>${__format1(tMax)}¬∞C</strong> (m√°x). `
              + `Amplitude t√©rmica: <strong>${amp==null?'‚Äî':amp.toFixed(1)}¬∞C</strong>${comp}.`;
}

function __renderDailyChart(payload, days){
  const canvas = document.getElementById('tempDailyChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  if(__tempDailyChart) __tempDailyChart.destroy();

  __tempDailyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: payload.labels,
      datasets: [
        { label: 'M√°x (¬∞C)', data: payload.max, tension: 0.25 },
        { label: 'M√©dia (¬∞C)', data: payload.avg, tension: 0.25 },
        { label: 'M√≠n (¬∞C)', data: payload.min, tension: 0.25 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: true },
        tooltip: { enabled: true }
      },
      scales: {
        y: { title: { display: true, text: '¬∞C' } }
      }
    }
  });

  __buildDailyInsight(days, payload);
}

async function __fetchDailySummaries(){
  if(__dailySummariesCache) return { summaries: __dailySummariesCache, meta: __dailySummariesMeta };

  const cfg = (window.WU_CONFIG || {});
  if(!cfg.stationId || !cfg.apiKey) throw new Error('WU_CONFIG missing');

  const base = 'https://api.weather.com/v2/pws/dailysummary/';
  const common = `?stationId=${encodeURIComponent(cfg.stationId)}&format=json&units=m&numericPrecision=decimal&apiKey=${encodeURIComponent(cfg.apiKey)}`;

  // tenta 30 dias (mais flex√≠vel). se falhar, tenta 7 dias.
  try{
    const r30 = await fetch(base + '30day' + common);
    if(!r30.ok) throw new Error('30day not ok');
    const d30 = await r30.json();
    const sums = Array.isArray(d30?.summaries) ? d30.summaries : [];
    if(!sums.length) throw new Error('30day empty');

    __dailySummariesCache = sums;
    __dailySummariesMeta = { endpoint: '30day', count: sums.length };
    return { summaries: sums, meta: __dailySummariesMeta };
  }catch(e){
    const r7 = await fetch(base + '7day' + common);
    if(!r7.ok) throw new Error('7day not ok');
    const d7 = await r7.json();
    const sums = Array.isArray(d7?.summaries) ? d7.summaries : [];
    if(!sums.length) throw new Error('7day empty');

    __dailySummariesCache = sums;
    __dailySummariesMeta = { endpoint: '7day', count: sums.length };
    return { summaries: sums, meta: __dailySummariesMeta };
  }
}

function __prepareDailyPayload(summaries, daysWanted){
  const byEpoch = summaries.slice().sort((a,b)=>(a.epoch||0)-(b.epoch||0));
  const slice = byEpoch.slice(-daysWanted);

  const labels = [];
  const min = [];
  const max = [];
  const avg = [];

  slice.forEach(s=>{
    const m = s.metric || {};
    const low = __safeNum(m.tempLow);
    const high = __safeNum(m.tempHigh);

    // label: dia/mes (curto)
    const dt = new Date(s.obsTimeLocal || s.obsTimeUtc || (s.epoch? s.epoch*1000 : Date.now()));
    labels.push(dt.toLocaleDateString('pt-PT', { day:'2-digit', month:'2-digit' }));

    min.push(low);
    max.push(high);

    const mid = (low!=null && high!=null) ? (low+high)/2 : null;
    avg.push(mid==null ? null : Number(mid.toFixed(1)));
  });

  return { labels, min, max, avg };
}


function __fmtYYYYMMDD(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}${m}${dd}`;
}

async function __fetchHistoryForDate(dateYYYYMMDD){
  const cfg = (window.WU_CONFIG || {});
  if(!cfg.stationId || !cfg.apiKey) throw new Error('WU_CONFIG missing');

  const url = 'https://api.weather.com/v2/pws/history/all'
    + '?stationId=' + encodeURIComponent(cfg.stationId)
    + '&format=json&units=m&numericPrecision=decimal'
    + '&date=' + encodeURIComponent(dateYYYYMMDD)
    + '&apiKey=' + encodeURIComponent(cfg.apiKey);

  const r = await fetch(url);
  if(!r.ok) throw new Error('history not ok');
  const d = await r.json();
  const obs = Array.isArray(d?.observations) ? d.observations : [];
  return obs;
}

function __extractTemp(o){
  // Robustez entre endpoints: por vezes vem temp, tempAvg, tempHigh/tempLow, ou mesmo em root.
  const m = o?.metric || {};
  const im = o?.imperial || {};
  const candidates = [
    m.temp,
    m.tempAvg,
    m.tempHigh,
    m.tempLow,
    im.temp,
    im.tempAvg,
    im.tempHigh,
    im.tempLow,
    o?.temp,
    o?.temperature,
    o?.tempC,
    o?.metricTemp
  ];
  for(const c of candidates){
    const n = __safeNum(c);
    if(n!=null) return n;
  }
  return null;
}

function __tempsFromObs(obs){
  const temps = [];
  obs.forEach(o=>{
    // Se houver high/low na observa√ß√£o, registamos ambos (ajuda a calcular extremos do dia)
    const m = o?.metric || {};
    const hi = __safeNum(m.tempHigh);
    const lo = __safeNum(m.tempLow);
    if(hi!=null) temps.push(hi);
    if(lo!=null) temps.push(lo);

    const t = __extractTemp(o);
    if(t!=null) temps.push(t);
  });
  return temps;
}

async function __buildDailyFromHistory(daysWanted){
  // Faz N pedidos (1 por dia) e calcula min/max/m√©dia.
  // Limite de concorr√™ncia simples para n√£o martelar o endpoint.
  const today = new Date();
  const dates = [];
  for(let i=daysWanted-1;i>=0;i--){
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    dates.push(d);
  }

  const labels = [];
  const min = [];
  const max = [];
  const avg = [];

  const concurrency = 3;
  let cursor = 0;

  async function worker(){
    while(cursor < dates.length){
      const myIdx = cursor++;
      const d = dates[myIdx];
      const ymd = __fmtYYYYMMDD(d);
      try{
        const obs = await __fetchHistoryForDate(ymd);
        const temps = __tempsFromObs(obs);
        labels[myIdx] = d.toLocaleDateString('pt-PT', { day:'2-digit', month:'2-digit' });
        if(temps.length){
          const mn = Math.min(...temps);
          const mx = Math.max(...temps);
          min[myIdx] = Number(mn.toFixed(1));
          max[myIdx] = Number(mx.toFixed(1));
          avg[myIdx] = Number(((mn+mx)/2).toFixed(1));
        }else{
          min[myIdx] = null; max[myIdx] = null; avg[myIdx] = null;
        }
      }catch(e){
        labels[myIdx] = d.toLocaleDateString('pt-PT', { day:'2-digit', month:'2-digit' });
        min[myIdx] = null; max[myIdx] = null; avg[myIdx] = null;
      }
    }
  }

  await Promise.all(Array.from({length: concurrency}, worker));
  return { labels, min, max, avg };
}

async function loadTempDaily(daysWanted=7){
  const note = document.getElementById('tempDailyNote');
  const insight = document.getElementById('tempDailyInsight');
  if(note) note.textContent = 'A carregar‚Ä¶';
  if(insight) insight.textContent = 'A carregar‚Ä¶';

  try{
    const { summaries, meta } = await __fetchDailySummaries();
    const endpoint = (meta && meta.endpoint) ? meta.endpoint : "?";
    const available = Array.isArray(summaries) ? summaries.length : 0;

    // Caso comum: o endpoint devolve dias suficientes (ex.: 7 dias)
    if(daysWanted <= available){
      __setActivePeriodo(daysWanted);
      if(note) note.textContent = `Fonte: Esta√ß√£o meteorol√≥gica da EB de Manhente (Weather Underground ‚Äî ${endpoint}).`;
      const payload = __prepareDailyPayload(summaries, daysWanted);
      __renderDailyChart(payload, daysWanted);
      return;
    }

    // Se pedires 14/30 e o endpoint de resumo s√≥ der 7 dias, constru√≠mos o di√°rio via /history/all (1 pedido por dia)
    __setActivePeriodo(daysWanted);
    if(note) note.textContent = `A carregar ${daysWanted} dias a partir do hist√≥rico da esta√ß√£o‚Ä¶`;

    const payload = await __buildDailyFromHistory(daysWanted);
    __renderDailyChart(payload, daysWanted);

    if(note) note.textContent = `Fonte: Esta√ß√£o meteorol√≥gica da EB de Manhente (Weather Underground ‚Äî history/all, ${daysWanted} dias).`;
  }catch(e){
    if(insight) insight.textContent = 'Hist√≥rico di√°rio indispon√≠vel.';
    if(note) note.textContent = 'N√£o foi poss√≠vel obter dados da esta√ß√£o.';
  }
}


function __renderHourlyChart(labels, temps){
  const canvas = document.getElementById('tempHourlyChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  if(__tempHourlyChart) __tempHourlyChart.destroy();

  __tempHourlyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Temperatura (¬∞C)', data: temps, tension: 0.25 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: true } },
      scales: {
        y: { title: { display: true, text: '¬∞C' } },
        x: { ticks: { maxRotation: 0, autoSkip: true } }
      }
    }
  });
}

async function loadTempHourly(){
  const el = document.getElementById('tempHourlyNote');
  if(el) el.textContent = 'A carregar‚Ä¶';

  try{
    const cfg = (window.WU_CONFIG || {});
    if(!cfg.stationId || !cfg.apiKey) throw new Error('WU_CONFIG missing');

    const url = 'https://api.weather.com/v2/pws/observations/all/1day'
      + '?stationId=' + encodeURIComponent(cfg.stationId)
      + '&format=json&units=m&numericPrecision=decimal'
      + '&apiKey=' + encodeURIComponent(cfg.apiKey);

    const r = await fetch(url);
    if(!r.ok) throw new Error('obs 1day not ok');
    const d = await r.json();

    const obs = Array.isArray(d?.observations) ? d.observations : [];
    if(!obs.length) throw new Error('obs empty');

    const now = new Date();
    const rowsToday = obs.filter(o => {
      const t = new Date(o.obsTimeLocal || o.obsTimeUtc || (o.epoch? o.epoch*1000 : NaN));
      return !Number.isNaN(t.getTime()) && __sameDayLocal(t, now);
    });

    const rows = rowsToday.length ? rowsToday : obs;

    // reduzir para 1 ponto a cada ~30 min (para n√£o ficar super carregado)
    const labels = [];
    const temps = [];
    let lastKeep = 0

    rows.sort((a,b)=>(a.epoch||0)-(b.epoch||0)).forEach(o=>{
      const t = new Date(o.obsTimeLocal || o.obsTimeUtc || (o.epoch? o.epoch*1000 : NaN));
      const temp = __extractTemp(o);
      if(Number.isNaN(t.getTime()) || temp==null) return;

      const ms = t.getTime();
      if(ms - lastKeep < 25*60*1000) return; // ~25 min
      lastKeep = ms;

      labels.push(t.toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'}));
      temps.push(temp);
    });

    if(labels.length < 2) throw new Error('not enough hourly points');

    __renderHourlyChart(labels, temps);
    if(el) el.textContent = 'Fonte: Esta√ß√£o meteorol√≥gica (observa√ß√µes do dia).';
  }catch(e){
    if(el) el.textContent = 'Hist√≥rico hor√°rio indispon√≠vel neste momento.';
  }
}

// bot√µes 7/14/30
(function(){
  const btns = document.querySelectorAll('.btn-periodo');
  if(!btns.length) return;

  btns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const days = Number(b.dataset.days || 7);
      __setActivePeriodo(days);
      loadTempDaily(days);
    });
  });

  // default
  __setActivePeriodo(7);
  loadTempDaily(7);
  loadTempHourly();
})();

</script>

</body>
</html>
