<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tempo â€“ EB de Manhente</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Montserrat',sans-serif;
  background:#f1f5f9;
  color:#1f2933;
}

header{
  background:linear-gradient(135deg,#2563eb,#1e40af);
  color:white;
  padding:25px 20px;
}

.header-content{
  max-width:900px;
  margin:auto;
  display:flex;
  align-items:center;
  gap:20px;
}

.header-content img{
  width:80px;
  background:white;
  border-radius:50%;
  padding:6px;
}

main{
  max-width:900px;
  margin:40px auto;
  padding:0 20px;
}

#cartao-clima{
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  color:white;
  border-radius:20px;
  padding:30px;
  text-align:center;
  box-shadow:0 12px 30px rgba(0,0,0,.2);
}

/* TEMP + ÃCONE */
#linha-temp{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
}

#icone-atual{
  font-size:2.2em;
  line-height:1;
}

#temp{
  font-size:3.2em;
  font-weight:700;
}

#dados,#hora,#fonte{
  margin-top:8px;
}

#acessos{
  margin-top:30px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}

.card{
  padding:18px;
  border-radius:14px;
  color:white;
  text-decoration:none;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  transition:.2s;
}

.card:hover{transform:translateY(-4px);}

.wu{background:linear-gradient(135deg,#f59e0b,#d97706);}
.wc{background:linear-gradient(135deg,#38bdf8,#0284c7);}
.pwl{background:linear-gradient(135deg,#22c55e,#15803d);}

#previsao{
  margin-top:50px;
}

#indicadores{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:15px;
  margin-bottom:25px;
}

.indicador,.dia,.sensor{
  background:white;
  padding:15px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}

#dias{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:15px;
}

.icone{
  font-size:2em;
  margin-bottom:6px;
}

#sensores{
  margin-top:50px;
}

#sensores-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:15px;
}

#legenda{
  margin-top:40px;
  padding:25px;
  background:white;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.logo-bora{
  max-width:180px;
  height:auto;
  margin:10px 0;
  transition:transform .2s, opacity .2s;
}

.logo-bora:hover{
  transform:scale(1.05);
  opacity:.9;
}

footer{
  margin:40px 0 20px;
  text-align:center;
  font-size:.8em;
  color:#6b7280;
}


/* SEMÃFORO SISMOS */
.semaforo{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  border-radius:50%;
  margin-right:6px;
  font-size:.7em;
  color:white;
  font-weight:700;
}
.verde{background:#16a34a;}
.amarelo{background:#f59e0b;}
.vermelho{background:#dc2626;}


details summary {
  cursor: pointer;
  font-size: 1.1em;
  margin-top: 25px;
}
details summary::marker {
  font-size: 1.2em;
}

</style>
  <script src="config.js"></script>
</head>

<body>




<header>
  <div class="header-content">
    <img src="logo_meteomanhente.png" alt="MeteoManhente â€“ EB de Manhente" style="width:72px;height:72px;object-fit:cover;border-radius:50%;" >
    <div>
      <h1>Tempo MeteorolÃ³gico</h1>
      <p>
        <a href="index.html" style="color:white; text-decoration:underline;">
          EB de Manhente
        </a>
        Â· Barcelos
      </p>
    </div>
  </div>
</header>

<main>

<div id="cartao-clima">
  <div id="linha-temp">
    <div id="icone-atual">â›…</div>
    <div id="temp">A carregarâ€¦</div>
  </div>
  <div id="dados"></div>
  <div id="hora"></div>
  <div id="fonte"></div>
</div>

<div id="acessos">
  <a class="card wu" href="https://www.wunderground.com/weather/pt/manhente/IMANHE1" target="_blank">
    Weather Underground<br><small>Acesso livre</small>
  </a>
  <a class="card wc" href="https://app.weathercloud.net/d7620547198#current" target="_blank">
    WeatherCloud<br><small>Acesso livre</small>
  </a>
  <a class="card pwl" href="https://proweatherlive.net/dashboard?id=69397140b67eb10008cb6d87" target="_blank">
    ProWeatherLive<br><small>Acesso reservado</small>
  </a>
</div>

<div id="previsao">
  <h2>PrevisÃ£o MeteorolÃ³gica â€“ Manhente</h2>

  <div id="indicadores">
    <div class="indicador"><strong>PressÃ£o</strong><br><span id="pressao">â€”</span></div>
    <div class="indicador"><strong>Ãndice UV</strong><br><span id="uv">â€”</span></div>
    <div class="indicador"><strong>Rajadas</strong><br><span id="rajadas">â€”</span></div>
  </div>

  <div id="dias"></div>

<div id="qualidade-ar" style="margin-top:50px;">
  <h2>Qualidade do Ar</h2>

  <div id="aq-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:15px;">
    <div class="indicador"><strong>PM2.5</strong><br><span id="pm25">â€”</span></div>
    <div class="indicador"><strong>Ãndice (EU)</strong><br><span id="aqi-eu">â€”</span></div>
    <div class="indicador"><strong>Estado</strong><br><span id="aq-estado">â€”</span></div>
  </div>

  <div style="margin-top:10px; font-size:.85em; color:#475569;">
    Atualizado: <span id="aq-hora">â€”</span> Â· Fonte: Openâ€‘Meteo (modelo)
  </div>
</div>

</div>

<details>
  <summary><strong>Sensores da estaÃ§Ã£o local</strong></summary>
  <div id="sensores">
    <h2>Sensores da EstaÃ§Ã£o Local</h2>
    <div id="sensores-grid"></div>
  </div>
</details>





<div id="sismos" style="margin-top:50px;">
  <h2>Sismos</h2>

  <div id="sismos-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:15px;">
    <details>
<summary><strong>Portugal â€“ mais recentes</strong></summary>
<div class="indicador">
      <strong>Portugal â€“ mais recentes</strong>
      <div id="sismos-pt-recentes" style="margin-top:10px; text-align:left;">A carregarâ€¦</div>
      <div style="margin-top:10px;">
        <a href="https://www.ipma.pt/pt/geofisica/sismicidade/" target="_blank" rel="noopener noreferrer">Ver sismicidade (IPMA)</a>
      </div>
    </div>
</details>

    <details>
<summary><strong>Portugal â€“ Norte prioritÃ¡rio</strong></summary>
<div class="indicador">
      <strong>Portugal â€“ Norte prioritÃ¡rio</strong>
      <div id="sismos-pt-norte" style="margin-top:10px; text-align:left;">A carregarâ€¦</div>
      <div style="margin-top:10px;">
        <a href="https://www.ipma.pt/pt/geofisica/sismicidade/" target="_blank" rel="noopener noreferrer">Ver sismicidade (IPMA)</a>
      </div>
    </div>
</details>

    <details>
<summary><strong>Mais relevantes no mundo</strong></summary>
<div class="indicador">
      <strong>Mais relevantes no mundo</strong>
      <div id="sismos-mundo" style="margin-top:10px; text-align:left;">A carregarâ€¦</div>
      <div style="margin-top:10px;">
        <a href="https://earthquake.usgs.gov/earthquakes/map/?extent=-90,-180&extent=90,180" target="_blank" rel="noopener noreferrer">Ver mapa (USGS)</a>
      </div>
    </div>
</details>
  </div>

  <div style="margin-top:10px; font-size:.85em; color:#475569;">
    ğŸŸ¢ Fraco &nbsp; ğŸŸ¡ Moderado &nbsp; ğŸ”´ Forte â€” classificaÃ§Ã£o baseada na magnitude.
  </div>
</div>

<div id="legenda">


  Projeto da AssociaÃ§Ã£o<br>
  <a href="https://borambientar.pt/" target="_blank" rel="noopener noreferrer">
    <img src="logo-bora-ambientar.png" alt="BORA AMBIENTAR" class="logo-bora">
  </a>
  <br>
  e da <strong>EB de Manhente</strong>
</div>

</main>

<footer>
  PÃ¡gina informativa com dados meteorolÃ³gicos
</footer>

<script>
const apiKey="cc9cbc0aeacb47899cbc0aeacbc7891b";

// 1 casa decimal
function format1(n){
  const x = Number(n);
  if (Number.isNaN(x)) return "â€”";
  return x.toFixed(1);
}

// ÃCONES (Open-Meteo weathercode)
function iconeTempo(code){
  if(code===0)return"â˜€ï¸";
  if([1,2].includes(code))return"ğŸŒ¤ï¸";
  if(code===3)return"â˜ï¸";
  if([45,48].includes(code))return"ğŸŒ«ï¸";
  if([51,53,55,61,63,65].includes(code))return"ğŸŒ§ï¸";
  if([66,67].includes(code))return"ğŸŒ§ï¸â„ï¸";
  if([71,73,75,77].includes(code))return"â„ï¸";
  if([80,81,82].includes(code))return"ğŸŒ¦ï¸";
  if([95,96,99].includes(code))return"â›ˆï¸";
  return"ğŸŒ¡ï¸";
}

// SENSOR CARD
function sensor(nome, valor, unidade=""){
  if(valor===undefined || valor===null) return "";
  return `<div class="sensor"><strong>${nome}</strong><br>${valor}${unidade}</div>`;
}

// UI ATUAL
function atualizarAtual(temp, hum, vento, fonte, icone){
  document.getElementById("temp").innerText = format1(temp) + "Â°C";
  document.getElementById("icone-atual").innerText = icone || "ğŸŒ¡ï¸";
  document.getElementById("dados").innerText =
    `Humidade: ${hum} Â· Vento: ${format1(vento)} km/h`;
  document.getElementById("hora").innerText =
    "Atualizado: "+new Date().toLocaleTimeString("pt-PT",{hour:"2-digit",minute:"2-digit"});
  document.getElementById("fonte").innerText = "Fonte: " + fonte;
}

// Buscar Ã­cone (estado do tempo) no Open-Meteo (sÃ³ para o Ã­cone)
let iconeAtual = "ğŸŒ¡ï¸";
const iconePromise = fetch("https://api.open-meteo.com/v1/forecast?latitude=41.5388&longitude=-8.6151&current_weather=true&timezone=Europe/Lisbon")
  .then(r=>r.json())
  .then(d=>{ iconeAtual = iconeTempo(d.current_weather.weathercode); })
  .catch(()=>{ iconeAtual = "ğŸŒ¡ï¸"; });

// WEATHER UNDERGROUND (estaÃ§Ã£o local)
Promise.all([iconePromise]).then(()=>{
  return fetch(`https://api.weather.com/v2/pws/observations/current?stationId=IMANHE1&format=json&units=m&apiKey=${apiKey}`);
})
.then(r=>r.json())
.then(d=>{
  if(!d.observations) throw "offline";
  const o=d.observations[0];

  atualizarAtual(
    o.metric.temp,
    o.humidity+"%",
    o.metric.windSpeed,
    "EstaÃ§Ã£o local",
    iconeAtual
  );

  document.getElementById("sensores-grid").innerHTML =
    sensor("PressÃ£o", o.metric.pressure, " hPa") +
    sensor("SensaÃ§Ã£o TÃ©rmica", format1(o.metric.heatIndex), " Â°C") +
    sensor("Ponto de Orvalho", format1(o.metric.dewpt), " Â°C") +
    sensor("Wind Chill", format1(o.metric.windChill), " Â°C") +
    sensor("Vento (atual)", o.metric.windSpeed, " km/h") +
    sensor("Rajada (mÃ¡x. recente)", o.metric.windGust, " km/h") +
    sensor("DireÃ§Ã£o do vento", o.winddir, "Â°") +
    sensor("Ãndice UV", o.uv) +
    sensor("RadiaÃ§Ã£o Solar", o.solarRadiation, " W/mÂ²") +
    sensor("Visibilidade", o.metric.visibility, " km") +
    sensor("Chuva (hora)", o.metric.precipRate, " mm/h") +
    sensor("Chuva (dia)", o.metric.precipToday, " mm") +
    sensor("Chuva acumulada", o.metric.precipTotal, " mm");
})
.catch(()=>{
  // FALLBACK (Open-Meteo total)
  fetch("https://api.open-meteo.com/v1/forecast?latitude=41.5388&longitude=-8.6151&current_weather=true&timezone=Europe/Lisbon")
  .then(r=>r.json())
  .then(d=>{
    atualizarAtual(
      d.current_weather.temperature,
      "â€”",
      d.current_weather.windspeed,
      "Modelo meteorolÃ³gico",
      iconeTempo(d.current_weather.weathercode)
    );
    // sensores ficam vazios no fallback
    document.getElementById("sensores-grid").innerHTML =
      `<div class="sensor"><strong>Sensores</strong><br>IndisponÃ­veis (estaÃ§Ã£o offline)</div>`;
  });
});

// PREVISÃƒO
fetch("https://api.open-meteo.com/v1/forecast?latitude=41.5388&longitude=-8.6151&daily=temperature_2m_max,temperature_2m_min,uv_index_max,precipitation_probability_max,weathercode&current=surface_pressure,wind_gusts_10m&timezone=Europe/Lisbon")
.then(r=>r.json())
.then(d=>{
  document.getElementById("pressao").innerText=d.current.surface_pressure+" hPa";
  document.getElementById("uv").innerText=d.daily.uv_index_max[0];
  document.getElementById("rajadas").innerText=format1(d.current.wind_gusts_10m)+" km/h";

  const dias=document.getElementById("dias");
  dias.innerHTML="";
  d.daily.time.slice(0,5).forEach((dia,i)=>{
    dias.innerHTML+=`
      <div class="dia">
        <div class="icone">${iconeTempo(d.daily.weathercode[i])}</div>
        <strong>${new Date(dia).toLocaleDateString("pt-PT",{weekday:"short"})}</strong><br>
        MÃ¡x: ${format1(d.daily.temperature_2m_max[i])}Â°C<br>
        MÃ­n: ${format1(d.daily.temperature_2m_min[i])}Â°C<br>
        Chuva: ${d.daily.precipitation_probability_max[i]}%
      </div>`;
  });
});



// =======================
// QUALIDADE DO AR (Open-Meteo Air Quality)
// =======================
function estadoArPorPM25(pm25){
  if(pm25===null || pm25===undefined || Number.isNaN(pm25)) return "â€”";
  // Escala simples (aprox.) baseada em orientaÃ§Ãµes comuns (Âµg/mÂ³)
  if(pm25 <= 5) return "Excelente";
  if(pm25 <= 10) return "Boa";
  if(pm25 <= 15) return "RazoÃ¡vel";
  if(pm25 <= 25) return "Moderada";
  if(pm25 <= 35) return "Fraca";
  if(pm25 <= 50) return "MÃ¡";
  return "Muito mÃ¡";
}

function fmtHoraCurta(dt){
  return dt.toLocaleTimeString("pt-PT",{hour:"2-digit",minute:"2-digit"});
}

function setAQ(elId, value){
  const el = document.getElementById(elId);
  if(!el) return;
  el.innerText = value;
}

fetch("https://air-quality-api.open-meteo.com/v1/air-quality?latitude=41.5388&longitude=-8.6151&current=pm2_5,european_aqi&timezone=Europe/Lisbon")
  .then(r=>r.json())
  .then(d=>{
    const pm25 = d?.current?.pm2_5;
    const aqi = d?.current?.european_aqi;

    setAQ("pm25", (pm25===undefined || pm25===null) ? "â€”" : (format1(pm25) + " Âµg/mÂ³"));
    setAQ("aqi-eu", (aqi===undefined || aqi===null) ? "â€”" : aqi);
    setAQ("aq-estado", estadoArPorPM25(pm25));
    setAQ("aq-hora", fmtHoraCurta(new Date()));
  })
  .catch(()=>{
    setAQ("aq-estado", "IndisponÃ­vel");
    setAQ("aq-hora", fmtHoraCurta(new Date()));
  });


// =======================
// SISMOS (USGS - dados pÃºblicos)
// =======================

// Feeds USGS GeoJSON (pÃºblicos)
const USGS_ALL_WEEK = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson";
const USGS_SIGNIFICANT_WEEK = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_week.geojson";

// IPMA (sismicidade Portugal) â€“ dados pÃºblicos (30 dias)
const IPMA_SEISMIC_CONT = "https://api.ipma.pt/open-data/observation/seismic/7.json";
const IPMA_SEISMIC_AZORES = "https://api.ipma.pt/open-data/observation/seismic/3.json";


// Portugal (bbox abrangente: continente + AÃ§ores/Madeira com folga)
const PT_BBOX = {
  minLat: 30.0,
  maxLat: 43.5,
  minLon: -32.5,
  maxLon: -6.0
};

function dentroBBox(lat, lon, bbox){
  return lat >= bbox.minLat && lat <= bbox.maxLat && lon >= bbox.minLon && lon <= bbox.maxLon;
}

function fmtData(ms){
  return new Date(ms).toLocaleString("pt-PT", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function fmtNum(n, casas=1){
  if(n === null || n === undefined) return "â€”";
  return Number(n).toFixed(casas);
}

function semaforoMag(mag){
  if(mag === null || mag === undefined) return "";
  if(mag < 4) return `<span class="semaforo verde">â—</span>`;
  if(mag < 6) return `<span class="semaforo amarelo">â—</span>`;
  return `<span class="semaforo vermelho">â—</span>`;
}

function criarLinhaSismo(f){
  const p = f.properties || {};
  const g = f.geometry || {};
  const coords = (g.coordinates || []);
  const depth = coords[2];

  const mag = p.mag;
  const place = p.place || "Local desconhecido";
  const time = p.time;
  const felt = p.felt; // nÂº de relatos "felt" (quando existe)
  const cdi = p.cdi;   // intensidade (quando existe)
  const url = p.url;   // link oficial do evento

  const badge =
    (felt ? `ğŸ‘¥ ${felt}` : "") +
    (cdi ? ` Â· Int. ${fmtNum(cdi,1)}` : "");

  return `
    <div style="padding:10px 0; border-bottom:1px solid #e5e7eb;">
      <div style="font-weight:700;">
        ${semaforoMag(mag)} M ${fmtNum(mag,1)} Â· ${place}
      </div>
      <div style="font-size:.9em; color:#334155;">
        ${fmtData(time)} Â· Prof.: ${fmtNum(depth,0)} km ${badge ? "Â· " + badge : ""}
      </div>
      ${url ? `<div style="margin-top:4px;"><a href="${url}" target="_blank" rel="noopener noreferrer">Detalhes</a></div>` : ""}
    </div>
  `;
}


// PreferÃªncias locais (Portugal)
// Ajusta este valor se quiseres um 'Norte' mais apertado/mais largo.
const NORTE_MIN_LAT = 40.2; // ~Minho/Porto para cima

function isNortePT(ev){
  const lat = parseFloat(ev.lat);
  return !Number.isNaN(lat) && lat >= NORTE_MIN_LAT;
}

function hasDegree(ev){
  return ev.degree !== null && ev.degree !== undefined && ev.degree !== "";
}


async function carregarSismosPortugal(){
  const elRecentes = document.getElementById("sismos-pt-recentes");
  const elNorte = document.getElementById("sismos-pt-norte");
  if(!elRecentes || !elNorte) return;

  try{
    const [r1, r2] = await Promise.all([
      fetch(IPMA_SEISMIC_CONT),
      fetch(IPMA_SEISMIC_AZORES)
    ]);

    const [cont, azo] = await Promise.all([r1.json(), r2.json()]);

    const items = []
      .concat((cont.data || []).map(x => ({...x, __area: "Continente/Madeira"})))
      .concat((azo.data || []).map(x => ({...x, __area: "AÃ§ores"})));

    const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

    const normalizados = items.map(it => {
      const t = new Date(it.time + "Z").getTime();
      return {...it, __t: t};
    }).filter(it => !Number.isNaN(it.__t) && it.__t >= weekAgo);

    // OPÃ‡ÃƒO 1 â€“ mais recentes
    const recentes = [...normalizados]
      .sort((a,b) => b.__t - a.__t)
      .slice(0, 8);

    // OPÃ‡ÃƒO 2 â€“ Norte prioritÃ¡rio
    const NORTE_MIN_LAT = 40.2;
    const norte = [...normalizados]
      .sort((a,b) => {
        const aN = (Number(a.lat) >= NORTE_MIN_LAT) ? 1 : 0;
        const bN = (Number(b.lat) >= NORTE_MIN_LAT) ? 1 : 0;
        if(bN !== aN) return bN - aN;
        return b.__t - a.__t;
      })
      .slice(0, 8);

    elRecentes.innerHTML = recentes.length
      ? recentes.map(renderIPMA).join("")
      : "<div>Sem registos na Ãºltima semana.</div>";

    elNorte.innerHTML = norte.length
      ? norte.map(renderIPMA).join("")
      : "<div>Sem registos no Norte na Ãºltima semana.</div>";

  }catch(e){
    elRecentes.innerHTML = "Erro ao carregar dados (IPMA)";
    elNorte.innerHTML = "Erro ao carregar dados (IPMA)";
  }
}


function renderIPMA(it){
  const mag = Number(it.magnitud);
  const badge = (it.degree !== null && it.degree !== undefined && String(it.degree).trim() !== "")
    ? ` Â· Intensidade ${it.degree}` : "";

  // Campo do local no IPMA pode variar; tentamos vÃ¡rios para nÃ£o ficar vazio.
  const placeCore =
    (it.local && String(it.local).trim()) ||
    (it.obsRegion && String(it.obsRegion).trim()) ||
    (it.region && String(it.region).trim()) ||
    (it.place && String(it.place).trim()) ||
    "Portugal";

  const place = `${placeCore} (${it.__area || ""})`.replace(/\s+\(\)/g,"").trim();

  return `
    <div style="padding:10px 0; border-bottom:1px solid #e5e7eb;">
      <div style="font-weight:700;">
        ${semaforoMag(mag)} M ${fmtNum(mag,1)} Â· ${place}
      </div>
      <div style="font-size:.9em; color:#334155;">
        ${fmtData(it.__t)} Â· Prof.: ${fmtNum(it.depth,0)} km${badge}
      </div>
    </div>
  `;
}

async function carregarSismosMundoRelevantes(){
  const el = document.getElementById("sismos-mundo");
  if(!el) return;

  try{
    const r = await fetch(USGS_SIGNIFICANT_WEEK);
    const data = await r.json();
    const feats = (data.features || [])
      .sort((a,b) => (b.properties.mag || 0) - (a.properties.mag || 0))
      .slice(0, 5);

    if(feats.length === 0){
      el.innerHTML = `<div style="color:#334155;">Sem sismos "significativos" registados (Ãºltima semana).</div>`;
      return;
    }

    el.innerHTML = feats.map(criarLinhaSismo).join("");
  }catch(e){
    el.innerHTML = `<div style="color:#b91c1c;">NÃ£o foi possÃ­vel carregar os dados (USGS).</div>`;
  }
}

// Carregar ao abrir a pÃ¡gina
carregarSismosPortugal();
carregarSismosMundoRelevantes();

</script>

</body>
</html>
